<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Szachy z AI</title>

<link rel="stylesheet"
href="https://unpkg.com/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"/>

<style>
body {
    background: #121212;
    color: white;
    font-family: Arial;
    display: flex;
    flex-direction: column;
    align-items: center;
}

#controls {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
}

select, button {
    padding: 6px;
    font-size: 14px;
}

#board {
    width: 420px;
    margin-top: 20px;
}

#timers {
    margin-top: 10px;
    font-size: 18px;
}
</style>
</head>
<body>

<h1>♟️ Szachy z AI</h1>

<div id="controls">
    <select id="side">
        <option value="white">Białe</option>
        <option value="black">Czarne</option>
    </select>

    <select id="level">
        <option value="1">AI łatwe</option>
        <option value="2">AI średnie</option>
        <option value="3">AI trudne</option>
    </select>

    <select id="time">
        <option value="60">1 minuta</option>
        <option value="180">3 minuty</option>
        <option value="300">5 minut</option>
        <option value="600">10 minut</option>
    </select>

    <button onclick="startGame()">Start</button>
</div>

<div id="timers">
    ⚪ <span id="whiteTime"></span> | ⚫ <span id="blackTime"></span>
</div>

<div id="board"></div>

<script src="https://unpkg.com/chess.js@1.0.0/chess.min.js"></script>
<script src="https://unpkg.com/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

<script>
let board, game;
let playerColor = 'w';
let aiDepth = 1;
let whiteTime, blackTime;
let timerInterval;

function startGame() {
    game = new Chess();

    playerColor = document.getElementById("side").value === "white" ? 'w' : 'b';
    aiDepth = parseInt(document.getElementById("level").value);

    let startTime = parseInt(document.getElementById("time").value);
    whiteTime = blackTime = startTime;

    updateTimers();
    clearInterval(timerInterval);
    timerInterval = setInterval(updateClock, 1000);

    board = Chessboard('board', {
        draggable: true,
        orientation: playerColor === 'w' ? 'white' : 'black',
        position: 'start',
        onDrop: onDrop
    });

    if (playerColor === 'b') setTimeout(makeAIMove, 500);
}

function updateClock() {
    if (game.turn() === 'w') whiteTime--;
    else blackTime--;

    updateTimers();

    if (whiteTime <= 0 || blackTime <= 0) {
        alert("⏱️ Koniec czasu!");
        clearInterval(timerInterval);
    }
}

function updateTimers() {
    document.getElementById("whiteTime").innerText = formatTime(whiteTime);
    document.getElementById("blackTime").innerText = formatTime(blackTime);
}

function formatTime(sec) {
    let m = Math.floor(sec / 60);
    let s = sec % 60;
    return `${m}:${s.toString().padStart(2, '0')}`;
}

function onDrop(source, target) {
    if (game.turn() !== playerColor) return 'snapback';

    let move = game.move({
        from: source,
        to: target,
        promotion: 'q'
    });

    if (move === null) return 'snapback';

    board.position(game.fen());
    setTimeout(makeAIMove, 300);
}

function makeAIMove() {
    if (game.game_over()) return;

    let move = minimaxRoot(aiDepth, game, true);
    game.move(move);
    board.position(game.fen());
}

function minimaxRoot(depth, game, isMax) {
    let bestMove = null;
    let bestValue = -9999;
    let moves = game.moves();

    for (let move of moves) {
        game.move(move);
        let value = minimax(depth - 1, game, -10000, 10000, false);
        game.undo();

        if (value > bestValue) {
            bestValue = value;
            bestMove = move;
        }
    }
    return bestMove;
}

function minimax(depth, game, alpha, beta, isMax) {
    if (depth === 0) return evaluate(game.board());

    let moves = game.moves();

    if (isMax) {
        let maxEval = -9999;
        for (let move of moves) {
            game.move(move);
            let eval = minimax(depth - 1, game, alpha, beta, false);
            game.undo();
            maxEval = Math.max(maxEval, eval);
            alpha = Math.max(alpha, eval);
            if (beta <= alpha) break;
        }
        return maxEval;
    } else {
        let minEval = 9999;
        for (let move of moves) {
            game.move(move);
            let eval = minimax(depth - 1, game, alpha, beta, true);
            game.undo();
            minEval = Math.min(minEval, eval);
            beta = Math.min(beta, eval);
            if (beta <= alpha) break;
        }
        return minEval;
    }
}

function evaluate(board) {
    const values = { p:10, n:30, b:30, r:50, q:90, k:900 };
    let score = 0;

    for (let row of board) {
        for (let piece of row) {
            if (piece) {
                let val = values[piece.type];
                score += piece.color === playerColor ? val : -val;
            }
        }
    }
    return score;
}
</script>

</body>
</html>
